<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Campus Connect — Navigation</title>
  <!-- Leaflet CSS -->
  <!-- Bootstrap 5 CSS and Icons for navbar consistency -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/static/style.css" rel="stylesheet" />

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #0f1720;
      --text: #e6edf3;
      --muted: #94a3b8;
      --mask: rgba(80, 94, 108, 0.65);
      --stroke: rgba(255, 255, 255, 0.9);
    }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); }
    #app { height: 100%; display: grid; grid-template-rows: auto 1fr; }
    header { padding: 10px 14px; background: var(--panel); border-bottom: 1px solid #1e293b; display: flex; align-items: center; gap: 10px; }
    header h1 { font-size: 16px; margin: 0; font-weight: 600; letter-spacing: 0.3px; }
    header .sub { font-size: 12px; color: var(--muted); }
    #map { height: 100%; width: 100%; }
    .status { position: absolute; top: 10px; right: 10px; background: rgba(15, 23, 32, 0.9); color: var(--text); padding: 8px 10px; border-radius: 8px; font-size: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.3); z-index: 1000; }
    .error { color: #fecaca; }
    .leaflet-container { background: #0b0f14; }
  </style>
</head>
<body class="map-page">
  <!-- Reuse navbar from index for consistency -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top border-bottom app-navbar">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center gap-2" href="/">
        <i class="bi bi-mortarboard-fill icon-primary"></i>
        <span class="fw-semibold">smart campus App</span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mapNav" aria-controls="mapNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="mapNav">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="#map">Map</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div id="app" class="pt-5 mt-4">
    <header class="px-3">
      <h1>smart campus App — Navigation</h1>
      <div class="sub">Branded map with highlighted buildings</div>
    </header>
    <div id="map" class="map-container"></div>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script>
    (async function init() {
      const statusEl = document.createElement('div');
      statusEl.className = 'status';
      statusEl.textContent = 'Loading map…';
      document.body.appendChild(statusEl);

      const API_BASE = (location.protocol === 'file:') ? 'http://localhost:5000' : location.origin;

      // Single combined fetch for config, boundary, locations
      let boundary, locations, config;
      try {
        const res = await fetch(`${API_BASE}/api/navigation/all`);
        if (!res.ok) throw new Error('Network response was not ok');
        const data = await res.json();
        boundary = data?.boundary || {};
        locations = Array.isArray(data?.locations) ? data.locations : [];
        config = data?.config || {};
      } catch (err) {
        statusEl.textContent = 'Failed to load data from backend.';
        statusEl.classList.add('error');
        console.error('Data fetch failed:', err);
        return;
      }

      // 2) Initialize Leaflet map
      const map = L.map('map', { preferCanvas: true, zoomControl: true });
      const center = Array.isArray(config.center) ? config.center : null;
      const defaultZoom = Number.isFinite(config.defaultZoom) ? config.defaultZoom : 17;
      if (center) {
        map.setView(center, defaultZoom);
      }

      // Minimalist, professional basemap (Carto Positron)
      const tiles = L.tileLayer(
        'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
        {
          attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
          maxZoom: 20,
          noWrap: true
        }
      ).addTo(map);

      // Create panes for layering
      map.createPane('mask');
      map.getPane('mask').style.zIndex = 350; // below buildings
      map.createPane('buildings');
      map.getPane('buildings').style.zIndex = 400;

      // 3) Fit map to campus boundary
      const campusCoords = Array.isArray(boundary?.coordinates) ? boundary.coordinates : [];
      if (campusCoords.length >= 3) {
        const bounds = L.latLngBounds(campusCoords);
        map.fitBounds(bounds.pad(0.2));
      } else {
        map.setView([0, 0], 2);
      }

      // 4) Campus Block mask: world rectangle with a hole for campus boundary
      const worldRing = [
        [-85, -180],
        [-85,  180],
        [ 85,  180],
        [ 85, -180],
        [-85, -180]
      ];
      if (campusCoords.length >= 3) {
        L.polygon([worldRing, campusCoords], {
          pane: 'mask',
          fill: true,
          fillColor: getComputedStyle(document.documentElement).getPropertyValue('--mask') || 'rgba(80,94,108,0.65)',
          fillOpacity: 0.65,
          color: 'transparent',
          weight: 0,
          interactive: false,
          bubblingMouseEvents: false,
          fillRule: 'evenodd'
        }).addTo(map);
      }

      // 5) Draw building polygons and bind popups
      const categoryColors = {
        Academic: '#2563eb',
        Admin: '#f59e0b',
        Hostel: '#10b981',
        Facility: '#8b5cf6',
        Sports: '#ef4444',
        General: '#3b82f6'
      };

      (locations || []).forEach((b) => {
        const coords = Array.isArray(b?.coordinates) ? b.coordinates : [];
        if (coords.length < 3) return;
        const name = b?.name || 'Building';
        const desc = b?.description || '';
        const category = b?.category || 'General';
        const fill = categoryColors[category] || categoryColors.General;

        const poly = L.polygon(coords, {
          pane: 'buildings',
          color: 'white',
          weight: 1,
          fillColor: fill,
          fillOpacity: 0.85
        }).addTo(map);

        poly.bindPopup(`<strong>${escapeHtml(name)}</strong><br>${escapeHtml(desc)}`);
      });

      statusEl.textContent = 'Loaded.';
      setTimeout(() => statusEl.remove(), 1200);

      function escapeHtml(str) {
        return String(str).replace(/[&<>"]/g, s => ({
          '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;'
        })[s]);
      }
    })();
  </script>
</body>
</html>

