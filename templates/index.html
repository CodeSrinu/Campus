<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Campus App</title>
  <!-- Bootstrap CSS & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- App Styles -->
  <link href="/static/style.css" rel="stylesheet" />

</head>
<body class="bg-body">
  <!-- Fixed Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top border-bottom app-navbar" id="top">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center gap-2" href="#">
        <i class="bi bi-mortarboard-fill icon-primary"></i>
        <span class="fw-semibold">Smart Campus App</span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="mainNav">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link requires-auth" href="/map"><i class="bi bi-geo-alt me-1"></i>Navigation</a></li>
          <li class="nav-item"><a class="nav-link" href="/events"><i class="bi bi-calendar-event me-1"></i>Events</a></li>
          <li class="nav-item"><a class="nav-link" href="/lost-found"><i class="bi bi-search me-1"></i>Lost &amp; Found</a></li>
          <li class="nav-item"><a class="nav-link" href="/cafeteria"><i class="bi bi-cup-hot me-1"></i>Cafeteria</a></li>
        </ul>
        <div class="d-flex gap-2">
          <!-- Login/Register buttons (shown when not logged in) -->
          <div id="authButtons">
            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#loginModal">
              <i class="bi bi-box-arrow-in-right me-1"></i>Login
            </button>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registerModal">
              <i class="bi bi-person-plus-fill me-1"></i>Register
            </button>
          </div>

          <!-- Profile section (shown when logged in) -->
          <div id="profileSection" class="d-flex align-items-center gap-2" style="display: none;">
            <div class="dropdown">
              <button class="btn btn-outline-primary dropdown-toggle d-flex align-items-center gap-2" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-person-circle"></i>
                <span id="profileName">User</span>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i>Profile</a></li>
                <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>Settings</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" onclick="logout()"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <main class="mt-5 pt-4">
    <!-- Hero -->
    <section class="py-5">

      <div class="container">
        <div class="row align-items-center g-4">
          <div class="col-12 col-lg-7">
            <h1 class="display-5 fw-bold mb-3 hero-title">Your Campus, Simplified.</h1>
            <p class="lead mb-4 hero-sub">
              The one-stop app for all your campus needs. From finding events to tracking your grievances, connect to your campus like never before.
            </p>

          </div>

                <!-- Centered vertical CTAs below title and content -->
                <div id="heroCTA" class="hero-cta mt-2 d-grid gap-2 justify-content-center">
                  <button type="button" class="btn btn-primary btn-lg hero-cta-btn" data-bs-toggle="modal" data-bs-target="#registerModal">
                    <i class="bi bi-person-plus-fill me-2"></i>Register
                  </button>
                  <button type="button" class="btn btn-outline-primary btn-lg hero-cta-btn" data-bs-toggle="modal" data-bs-target="#loginModal">
                    <i class="bi bi-box-arrow-in-right me-2"></i>Login
                  </button>
                </div>

                <!-- Welcome message for logged in users -->
                <div id="welcomeMessage" class="hero-cta mt-2 text-center" style="display: none;">
                  <h4 class="text-primary">Welcome back, <span id="welcomeName">User</span>!</h4>
                  <p class="text-muted">Explore all the features of Smart Campus App</p>
                </div>


        </div>
      </div>
    </section>


    <!-- Feature Highlights (soft panel) -->
    <section class="section-features pb-5">
      <div class="container">
        <div class="glass-card p-3 p-md-4 rounded-4 shadow-soft">
          <a class="feature-item requires-auth" href="/map">
            <i class="bi bi-geo-alt icon-primary"></i>
            <div>
              <div class="fw-semibold">Navigation</div>
              <div class="small text-muted">Explore campus with an interactive, branded map.</div>
            </div>
          </a>
          <a class="feature-item" href="/events">
            <i class="bi bi-calendar-event icon-primary"></i>
            <div>
              <div class="fw-semibold">Events</div>
              <div class="small text-muted">Stay updated with official announcements.</div>
            </div>
          </a>
          <a class="feature-item" href="/lost-found">
            <i class="bi bi-search icon-primary"></i>
            <div>
              <div class="fw-semibold">Lost &amp; Found</div>
              <div class="small text-muted">Report and recover items with privacy-first contact.</div>
            </div>
          </a>
          <a class="feature-item" href="/cafeteria">
            <div class="feature-icon">
              <i class="bi bi-cup-hot"></i>
            </div>
            <h3>Cafeteria</h3>
            <p>Check daily menus, prices, and real-time crowd levels to plan your meals efficiently.</p>
          </a>
        </div>
      </div>
    </section>

    <footer class="py-4 border-top footer-bar">
      <div class="container small text-muted d-flex flex-wrap gap-2 align-items-center">
        <span>&copy; 2025 Smart Campus App — NIT AP</span>
        <span class="badge rounded-pill badge-gold">MVP First</span>
        <span class="badge rounded-pill badge-neutral">Privacy</span>
        <span class="badge rounded-pill badge-neutral">Crowdsourcing</span>
      </div>
    </footer>
  </main>

  <!-- Login Modal -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="loginLabel"><i class="bi bi-box-arrow-in-right me-2"></i>Login</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="loginForm">
            <div class="mb-3">
              <label class="form-label">Username</label>
              <input type="text" class="form-control" id="loginUsername" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Password</label>
              <input type="password" class="form-control" id="loginPassword" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="loginBtn">Login</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Register Modal -->
  <div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="registerLabel"><i class="bi bi-person-plus-fill me-2"></i>Register</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="registerForm">
            <div class="mb-3">
              <label class="form-label">Name</label>
              <input type="text" class="form-control" id="registerName" required>
            </div>
            <div class="row">
              <div class="col-6 mb-3">
                <label class="form-label">Year</label>
                <select class="form-select" id="registerYear" required>
                  <option value="" selected disabled>Choose…</option>
                  <option>1</option>
                  <option>2</option>
                  <option>3</option>
                  <option>4</option>
                </select>
              </div>
              <div class="col-6 mb-3">
                <label class="form-label">Branch</label>
                <select class="form-select" id="registerBranch" required>
                  <option value="" selected disabled>Choose…</option>
                  <option>CSE</option>
                  <option>ECE</option>
                  <option>EEE</option>
                  <option>ME</option>
                  <option>CE</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Password</label>
              <input type="password" class="form-control" id="registerPassword" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="createAccountBtn">Create Account</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Status pill (health) -->
  <div id="status" class="position-fixed bottom-0 end-0 m-3 px-3 py-2 rounded-pill border bg-white small shadow-sm">
    Checking backend…
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script>
    // Palette to Bootstrap variables
    document.documentElement.style.setProperty('--bs-primary', '#0f1e4b');
    document.documentElement.style.setProperty('--bs-body-bg', '#f7f9fc');
    document.documentElement.style.setProperty('--bs-body-color', '#0f172a');

    // Coming soon links
    document.querySelectorAll('[data-coming]').forEach(el => {
      el.addEventListener('click', (e) => {
        e.preventDefault();
        const toast = document.createElement('div');
        toast.className = 'toast align-items-center text-bg-light border-0 show position-fixed bottom-0 start-50 translate-middle-x mb-4 shadow';
        toast.role = 'alert';
        toast.style.minWidth = '260px';
        toast.innerHTML = `<div class="d-flex"><div class="toast-body"><i class="bi bi-info-circle me-2" style="color:#4b0082"></i>Section coming soon!</div><button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2500);
      });
    });

    // Health pill
    (async function() {
      const pill = document.getElementById('status');
      try {
        const res = await fetch('/health', { cache: 'no-store' });
        const data = await res.json();
        if (data && data.status) {
          pill.innerHTML = `<span class="me-2" style="display:inline-block;width:8px;height:8px;border-radius:999px;background:#22c55e"></span>${data.status}`;
        } else {
          pill.innerHTML = `<span class="me-2" style="display:inline-block;width:8px;height:8px;border-radius:999px;background:#f59e0b"></span>Unknown`;
        }
      } catch(e) {
        pill.innerHTML = `<span class="me-2" style="display:inline-block;width:8px;height:8px;border-radius:999px;background:#ef4444"></span>Offline`;
      }
    })();

    // Authentication state
    let isLoggedIn = false;
    let currentUser = null;

    // UI Elements
    const authButtons = document.getElementById('authButtons');
    const profileSection = document.getElementById('profileSection');
    const profileName = document.getElementById('profileName');
    const heroCTA = document.getElementById('heroCTA');
    const welcomeMessage = document.getElementById('welcomeMessage');
    const welcomeName = document.getElementById('welcomeName');

    // Enhanced API helper function with proper JSON handling
    async function apiCall(url, method = 'GET', data = null) {
      const options = {
        method,
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        credentials: 'include' // Include cookies for session management
      };

      if (data) {
        options.body = JSON.stringify(data);
      }

      try {
        console.log(`Making ${method} request to ${url}`, data); // Debug logging

        const response = await fetch(url, options);
        console.log(`Response status: ${response.status}, Content-Type: ${response.headers.get('content-type')}`);

        // Check if response is actually JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const textResponse = await response.text();
          console.error('Non-JSON response received:', textResponse);
          return {
            success: false,
            message: 'Server returned non-JSON response. Please check server configuration.'
          };
        }

        // Parse JSON response
        const result = await response.json();
        console.log('API response:', result); // Debug logging

        // Return the result regardless of HTTP status
        // The success field in the JSON will indicate if the operation was successful
        return result;

      } catch (error) {
        console.error('API call failed:', error);

        // Handle specific error types
        if (error.name === 'SyntaxError' && error.message.includes('JSON')) {
          return {
            success: false,
            message: 'Server returned invalid JSON. Please check server configuration.'
          };
        }

        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          return {
            success: false,
            message: 'Network connection failed. Please check if the server is running.'
          };
        }

        return {
          success: false,
          message: `Network error: ${error.message}`
        };
      }
    }

    // Show/Hide UI based on login status
    function updateUI() {
      console.log('Updating UI - isLoggedIn:', isLoggedIn, 'currentUser:', currentUser);

      if (isLoggedIn && currentUser) {
        console.log('User is logged in - hiding auth buttons, showing profile');

        // HIDE login/register buttons completely
        if (authButtons) {
          authButtons.style.display = 'none';
          authButtons.style.visibility = 'hidden';
          console.log('Hidden navbar auth buttons');
        }
        if (heroCTA) {
          heroCTA.style.display = 'none';
          heroCTA.style.visibility = 'hidden';
          console.log('Hidden hero auth buttons');
        }

        // SHOW profile section
        if (profileSection) {
          profileSection.style.display = 'flex';
          profileSection.style.visibility = 'visible';
          console.log('Shown profile section');
        }

        // Show welcome message if exists
        if (welcomeMessage) {
          welcomeMessage.style.display = 'block';
          if (welcomeName) {
            welcomeName.textContent = currentUser;
          }
          console.log('Shown welcome message');
        }

        // Update user name in profile
        if (profileName) {
          profileName.textContent = currentUser;
          console.log('Updated profile name to:', currentUser);
        }

        console.log('✅ UI Updated: User logged in as', currentUser);
      } else {
        console.log('User is not logged in - showing auth buttons, hiding profile');

        // SHOW login/register buttons
        if (authButtons) {
          authButtons.style.display = 'flex';
          authButtons.style.visibility = 'visible';
          console.log('Shown navbar auth buttons');
        }
        if (heroCTA) {
          heroCTA.style.display = 'block';
          heroCTA.style.visibility = 'visible';
          console.log('Shown hero auth buttons');
        }

        // HIDE profile section
        if (profileSection) {
          profileSection.style.display = 'none';
          profileSection.style.visibility = 'hidden';
          console.log('Hidden profile section');
        }

        // Hide welcome message if exists
        if (welcomeMessage) {
          welcomeMessage.style.display = 'none';
          console.log('Hidden welcome message');
        }

        console.log('✅ UI Updated: User logged out');
      }
    }

    // Enhanced Register modal action
    document.getElementById('createAccountBtn').addEventListener('click', async () => {
      const btn = document.getElementById('createAccountBtn');

      try {
        // Get form data
        const name = document.getElementById('registerName').value.trim();
        const year = document.getElementById('registerYear').value;
        const branch = document.getElementById('registerBranch').value;
        const password = document.getElementById('registerPassword').value;

        console.log('Registration form data:', { name, year, branch, password: '***' });

        // Client-side validation
        if (!name || name.length < 2) {
          alert('Please enter a valid name (at least 2 characters).');
          return;
        }

        if (!year) {
          alert('Please select your year.');
          return;
        }

        if (!branch) {
          alert('Please select your branch.');
          return;
        }

        if (!password || password.length < 4) {
          alert('Please enter a password (at least 4 characters).');
          return;
        }

        // Disable button to prevent double submission
        btn.disabled = true;
        btn.textContent = 'Creating Account...';

        // Call registration API
        const result = await apiCall('/api/auth/register', 'POST', {
          name: name,
          year: year,
          branch: branch,
          password: password
        });

        // Re-enable button
        btn.disabled = false;
        btn.textContent = 'Create Account';

        // Handle response
        if (result && result.success) {
          // Set user as logged in
          currentUser = result.user.name;
          isLoggedIn = true;

          console.log('Registration successful - updating UI');

          // Update UI immediately and force hide auth buttons
          updateUI();

          // Double-check: Force hide auth buttons
          setTimeout(() => {
            if (authButtons) authButtons.style.display = 'none';
            if (heroCTA) heroCTA.style.display = 'none';
            if (profileSection) profileSection.style.display = 'flex';
          }, 100);

          // Show success message
          alert(`Account created successfully! Welcome, ${result.user.name}!`);

          // Clear form and close modal
          document.getElementById('registerForm').reset();
          const modal = bootstrap.Modal.getInstance(document.getElementById('registerModal'));
          modal && modal.hide();
        } else {
          // Show error message from server or generic message
          const errorMessage = result && result.message ? result.message : 'Registration failed. Please try again.';
          alert(errorMessage);
          console.error('Registration failed:', result);
        }

      } catch (error) {
        console.error('Registration error:', error);
        alert('An unexpected error occurred during registration. Please try again.');

        // Re-enable button
        btn.disabled = false;
        btn.textContent = 'Create Account';
      }
    });

    // Enhanced Login modal action
    document.getElementById('loginBtn').addEventListener('click', async () => {
      const btn = document.getElementById('loginBtn');

      try {
        // Get form data
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value;

        console.log('Login form data:', { username, password: '***' });

        // Client-side validation
        if (!username || username.length < 2) {
          alert('Please enter a valid username.');
          return;
        }

        if (!password) {
          alert('Please enter your password.');
          return;
        }

        // Disable button to prevent double submission
        btn.disabled = true;
        btn.textContent = 'Logging in...';

        // Call login API
        const result = await apiCall('/api/auth/login', 'POST', {
          username: username,
          password: password
        });

        // Re-enable button
        btn.disabled = false;
        btn.textContent = 'Login';

        // Handle response
        if (result && result.success) {
          // Set user as logged in
          currentUser = result.user.name;
          isLoggedIn = true;

          console.log('Login successful - updating UI');

          // Update UI immediately and force hide auth buttons
          updateUI();

          // Double-check: Force hide auth buttons
          setTimeout(() => {
            if (authButtons) authButtons.style.display = 'none';
            if (heroCTA) heroCTA.style.display = 'none';
            if (profileSection) profileSection.style.display = 'flex';
          }, 100);

          // Show success message
          alert(`Welcome back, ${result.user.name}!`);

          // Clear form and close modal
          document.getElementById('loginForm').reset();
          const modal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
          modal && modal.hide();
        } else {
          // Show error message from server or generic message
          const errorMessage = result && result.message ? result.message : 'Login failed. Please check your credentials.';
          alert(errorMessage);
          console.error('Login failed:', result);
        }

      } catch (error) {
        console.error('Login error:', error);
        alert('An unexpected error occurred during login. Please try again.');

        // Re-enable button
        btn.disabled = false;
        btn.textContent = 'Login';
      }
    });

    // Logout function
    async function logout() {
      try {
        console.log('Logging out user...');

        // Call logout API
        const result = await apiCall('/api/auth/logout', 'POST');

        // Clear authentication state regardless of API response
        isLoggedIn = false;
        currentUser = null;

        // Update UI immediately
        updateUI();

        if (result.success) {
          alert('Logged out successfully!');
        } else {
          alert('Logged out (session cleared)');
        }
      } catch (error) {
        console.error('Logout error:', error);
        // Still clear local state even if API fails
        isLoggedIn = false;
        currentUser = null;
        updateUI();
        alert('Logged out (session cleared)');
      }
    }

    // Check authentication status on page load
    async function checkAuthStatus() {
      try {
        console.log('Checking authentication status...');
        const result = await apiCall('/api/auth/status');

        console.log('Auth status result:', result);

        if (result.authenticated && result.user) {
          isLoggedIn = true;
          currentUser = result.user.name;
          console.log('User is authenticated:', result.user.name);
        } else {
          isLoggedIn = false;
          currentUser = null;
          console.log('User is not authenticated');
        }

        // Update UI based on authentication state
        updateUI();
      } catch (error) {
        console.error('Auth status check error:', error);
        // Default to not authenticated on error
        isLoggedIn = false;
        currentUser = null;
        updateUI();
      }
    }

    // Protected routes (prototype)
    function protectNavigation(e){
      if(!isLoggedIn){
        e.preventDefault();
        const regModal = new bootstrap.Modal(document.getElementById('registerModal'));
        regModal.show();
      }
    }
    document.querySelectorAll('.requires-auth').forEach(el=>{
      el.addEventListener('click', protectNavigation);
    });

    // Initialize authentication status on page load
    checkAuthStatus();
  </script>
</body>
</html>

