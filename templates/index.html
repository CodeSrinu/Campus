<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Campus App</title>
  <!-- Bootstrap CSS & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- App Styles -->
  <link href="/static/style.css" rel="stylesheet" />

  <!-- Feature Cards Styles -->
  <style>
      /* Feature Cards Styling */
      .feature-card {
          display: block;
          height: 100%;
          color: inherit;
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .feature-card-inner {
          background: linear-gradient(135deg, #ffffff 0%, #F8FBFA 100%);
          border: 1px solid rgba(12, 53, 69, 0.1);
          border-radius: 20px;
          padding: 2rem;
          height: 100%;
          display: flex;
          flex-direction: column;
          position: relative;
          overflow: hidden;
          box-shadow: 0 4px 20px rgba(12, 53, 69, 0.08);
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .feature-card-inner::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          height: 4px;
          background: linear-gradient(90deg, #0C3545, #007BFF, #8C7570);
          opacity: 0;
          transition: opacity 0.3s ease;
      }

      .feature-card:hover .feature-card-inner {
          transform: translateY(-8px);
          box-shadow: 0 20px 40px rgba(12, 53, 69, 0.15);
          border-color: rgba(12, 53, 69, 0.2);
      }

      .feature-card:hover .feature-card-inner::before {
          opacity: 1;
      }

      .feature-icon-wrapper {
          width: 70px;
          height: 70px;
          background: linear-gradient(135deg, #0C3545 0%, #007BFF 100%);
          border-radius: 18px;
          display: flex;
          align-items: center;
          justify-content: center;
          margin-bottom: 1.5rem;
          transition: all 0.3s ease;
          box-shadow: 0 8px 25px rgba(12, 53, 69, 0.3);
      }

      .feature-card:hover .feature-icon-wrapper {
          transform: scale(1.1) rotate(5deg);
          box-shadow: 0 12px 35px rgba(12, 53, 69, 0.4);
      }

      .feature-icon {
          font-size: 1.8rem;
          color: white;
          transition: all 0.3s ease;
      }

      .feature-content {
          flex: 1;
          margin-bottom: 1rem;
      }

      .feature-title {
          font-size: 1.4rem;
          font-weight: 700;
          color: #0C3545;
          margin-bottom: 0.75rem;
          transition: color 0.3s ease;
      }

      .feature-card:hover .feature-title {
          color: #007BFF;
      }

      .feature-description {
          color: #8C7570;
          font-size: 0.95rem;
          line-height: 1.6;
          margin: 0;
          transition: color 0.3s ease;
      }

      .feature-card:hover .feature-description {
          color: #0C3545;
      }

      .feature-arrow {
          align-self: flex-end;
          width: 40px;
          height: 40px;
          background: rgba(12, 53, 69, 0.1);
          border-radius: 12px;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.3s ease;
      }

      .feature-card:hover .feature-arrow {
          background: #0C3545;
          transform: translateX(5px);
      }

      .feature-arrow i {
          font-size: 1.1rem;
          color: #0C3545;
          transition: all 0.3s ease;
      }

      .feature-card:hover .feature-arrow i {
          color: white;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
          .feature-card-inner {
              padding: 1.5rem;
          }

          .feature-icon-wrapper {
              width: 60px;
              height: 60px;
              margin-bottom: 1rem;
          }

          .feature-icon {
              font-size: 1.5rem;
          }

          .feature-title {
              font-size: 1.25rem;
          }

          .feature-description {
              font-size: 0.9rem;
          }
      }

      /* Section header styling */
      .display-6 {
          background: linear-gradient(135deg, #0C3545 0%, #007BFF 100%);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
      }
  </style>

</head>
<body class="bg-body">
  <!-- Fixed Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top border-bottom app-navbar" id="top">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center gap-2" href="#">
        <i class="bi bi-mortarboard-fill icon-primary"></i>
        <span class="fw-semibold">Smart Campus App</span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="mainNav">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link requires-auth" href="/map"><i class="bi bi-geo-alt me-1"></i>Navigation</a></li>
          <li class="nav-item"><a class="nav-link" href="/events"><i class="bi bi-calendar-event me-1"></i>Events</a></li>
          <li class="nav-item"><a class="nav-link" href="/lost-found"><i class="bi bi-search me-1"></i>Lost &amp; Found</a></li>
          <li class="nav-item"><a class="nav-link" href="/cafeteria"><i class="bi bi-cup-hot me-1"></i>Cafeteria</a></li>
        </ul>
        <div class="d-flex gap-2">
          <!-- Login/Register buttons (shown when not logged in) -->
          <div id="authButtons">
            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#loginModal">
              <i class="bi bi-box-arrow-in-right me-1"></i>Login
            </button>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registerModal">
              <i class="bi bi-person-plus-fill me-1"></i>Register
            </button>
          </div>

          <!-- Profile section (shown when logged in) -->
          <div id="profileSection" class="d-flex align-items-center gap-2" style="display: none;">
            <div class="dropdown">
              <button class="btn btn-outline-primary dropdown-toggle d-flex align-items-center gap-2" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-person-circle"></i>
                <span id="profileName">User</span>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i>Profile</a></li>
                <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>Settings</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" onclick="logout()"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <main class="mt-5 pt-4">
    <!-- Hero -->
    <section class="py-5">

      <div class="container">
        <div class="row align-items-center g-4">
          <div class="col-12 col-lg-7">
            <h1 class="display-5 fw-bold mb-3 hero-title">Your Smart Campus</h1>
            <p class="lead mb-4 hero-sub">
              The one-stop app for all your campus needs. From finding events to tracking your grievances, connect to your campus like never before.
            </p>

          </div>

                <!-- Centered vertical CTAs below title and content -->
                <div id="heroCTA" class="hero-cta mt-2 d-grid gap-2 justify-content-center">
                  <button type="button" class="btn btn-primary btn-lg hero-cta-btn" data-bs-toggle="modal" data-bs-target="#registerModal">
                    <i class="bi bi-person-plus-fill me-2"></i>Register
                  </button>
                  <button type="button" class="btn btn-outline-primary btn-lg hero-cta-btn" data-bs-toggle="modal" data-bs-target="#loginModal">
                    <i class="bi bi-box-arrow-in-right me-2"></i>Login
                  </button>
                </div>

                <!-- Welcome message for logged in users -->
                <div id="welcomeMessage" class="hero-cta mt-2 text-center" style="display: none;">
                  <h4 class="text-primary">Welcome back, <span id="welcomeName">User</span>!</h4>
                  <p class="text-muted">Explore all the features of Smart Campus App</p>
                </div>


        </div>
      </div>
    </section>


    <!-- Features Section -->
    <section class="py-5 bg-light">
      <div class="container">
        <div class="row justify-content-center mb-4">
          <div class="col-lg-8 text-center">
            <h2 class="display-6 fw-bold mb-3">Campus Features</h2>
            <p class="lead text-muted">Everything you need for your campus life, all in one place</p>
          </div>
        </div>

        <div class="row g-4">
          <!-- Navigation Card -->
          <div class="col-12 col-md-6">
            <a href="/map" class="feature-card requires-auth text-decoration-none">
              <div class="feature-card-inner">
                <div class="feature-icon-wrapper">
                  <i class="bi bi-geo-alt feature-icon"></i>
                </div>
                <div class="feature-content">
                  <h3 class="feature-title">Navigation</h3>
                  <p class="feature-description">Explore campus with an interactive, branded map and find your way around easily.</p>
                </div>
                <div class="feature-arrow">
                  <i class="bi bi-arrow-right"></i>
                </div>
              </div>
            </a>
          </div>

          <!-- Events Card -->
          <div class="col-12 col-md-6">
            <a href="/events" class="feature-card text-decoration-none">
              <div class="feature-card-inner">
                <div class="feature-icon-wrapper">
                  <i class="bi bi-calendar-event feature-icon"></i>
                </div>
                <div class="feature-content">
                  <h3 class="feature-title">Events</h3>
                  <p class="feature-description">Stay updated with official announcements and never miss important campus events.</p>
                </div>
                <div class="feature-arrow">
                  <i class="bi bi-arrow-right"></i>
                </div>
              </div>
            </a>
          </div>

          <!-- Lost & Found Card -->
          <div class="col-12 col-md-6">
            <a href="/lost-found" class="feature-card text-decoration-none">
              <div class="feature-card-inner">
                <div class="feature-icon-wrapper">
                  <i class="bi bi-search feature-icon"></i>
                </div>
                <div class="feature-content">
                  <h3 class="feature-title">Lost &amp; Found</h3>
                  <p class="feature-description">Report and recover items with privacy-first contact system for secure communication.</p>
                </div>
                <div class="feature-arrow">
                  <i class="bi bi-arrow-right"></i>
                </div>
              </div>
            </a>
          </div>

          <!-- Cafeteria Card -->
          <div class="col-12 col-md-6">
            <a href="/cafeteria" class="feature-card text-decoration-none">
              <div class="feature-card-inner">
                <div class="feature-icon-wrapper">
                  <i class="bi bi-cup-hot feature-icon"></i>
                </div>
                <div class="feature-content">
                  <h3 class="feature-title">Cafeteria</h3>
                  <p class="feature-description">Check daily menus, prices, and real-time crowd levels to plan your meals efficiently.</p>
                </div>
                <div class="feature-arrow">
                  <i class="bi bi-arrow-right"></i>
                </div>
              </div>
            </a>
          </div>
        </div>
      </div>
    </section>

    <!-- AI Assistant Section -->
    <section class="py-5 bg-white">
      <div class="container">
        <div class="row justify-content-center">
          <div class="col-lg-8">
            <div class="text-center mb-4">
              <h2 class="display-6 fw-bold mb-3">🤖 AI Campus Assistant</h2>
              <p class="lead text-muted">Ask questions about campus life, get help with academics, or chat about anything!</p>
            </div>

            <div class="card shadow-sm">
              <div class="card-body">
                <div class="mb-3">
                  <label for="aiInput" class="form-label">Ask the AI Assistant:</label>
                  <textarea class="form-control" id="aiInput" rows="3" placeholder="Hello AI, can you help me with campus information?"></textarea>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                  <button class="btn btn-primary" id="sendAIRequest">
                    <i class="bi bi-send"></i> Send Message
                  </button>
                  <button class="btn btn-outline-secondary" id="clearAIChat">
                    <i class="bi bi-trash"></i> Clear
                  </button>
                </div>

                <!-- Loading State -->
                <div id="aiLoading" class="text-center mt-3" style="display: none;">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <p class="mt-2 text-muted">AI is thinking...</p>
                </div>

                <!-- Response Area -->
                <div id="aiResponse" class="mt-3"></div>

                <!-- Error Area -->
                <div id="aiError" class="mt-3"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <footer class="py-4 border-top footer-bar">
      <div class="container small text-muted d-flex flex-wrap gap-2 align-items-center">
        <span>&copy; 2025 Smart Campus App — NIT AP</span>
        <span class="badge rounded-pill badge-gold">MVP First</span>
        <span class="badge rounded-pill badge-neutral">Privacy</span>
        <span class="badge rounded-pill badge-neutral">Crowdsourcing</span>
      </div>
    </footer>
  </main>

  <!-- Login Modal -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="loginLabel"><i class="bi bi-box-arrow-in-right me-2"></i>Login</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="loginForm">
            <div class="mb-3">
              <label class="form-label">Username</label>
              <input type="text" class="form-control" id="loginUsername" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Password</label>
              <input type="password" class="form-control" id="loginPassword" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="loginBtn">Login</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Register Modal -->
  <div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="registerLabel"><i class="bi bi-person-plus-fill me-2"></i>Register</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="registerForm">
            <div class="mb-3">
              <label class="form-label">Name</label>
              <input type="text" class="form-control" id="registerName" required>
            </div>
            <div class="row">
              <div class="col-6 mb-3">
                <label class="form-label">Year</label>
                <select class="form-select" id="registerYear" required>
                  <option value="" selected disabled>Choose…</option>
                  <option>1</option>
                  <option>2</option>
                  <option>3</option>
                  <option>4</option>
                </select>
              </div>
              <div class="col-6 mb-3">
                <label class="form-label">Branch</label>
                <select class="form-select" id="registerBranch" required>
                  <option value="" selected disabled>Choose…</option>
                  <option>CSE</option>
                  <option>ECE</option>
                  <option>EEE</option>
                  <option>ME</option>
                  <option>CE</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Password</label>
              <input type="password" class="form-control" id="registerPassword" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="createAccountBtn">Create Account</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Status pill (health) -->
  <div id="status" class="position-fixed bottom-0 end-0 m-3 px-3 py-2 rounded-pill border bg-white small shadow-sm">
    Checking backend…
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script>
    // Palette to Bootstrap variables
    document.documentElement.style.setProperty('--bs-primary', '#0f1e4b');
    document.documentElement.style.setProperty('--bs-body-bg', '#f7f9fc');
    document.documentElement.style.setProperty('--bs-body-color', '#0f172a');

    // Coming soon links
    document.querySelectorAll('[data-coming]').forEach(el => {
      el.addEventListener('click', (e) => {
        e.preventDefault();
        const toast = document.createElement('div');
        toast.className = 'toast align-items-center text-bg-light border-0 show position-fixed bottom-0 start-50 translate-middle-x mb-4 shadow';
        toast.role = 'alert';
        toast.style.minWidth = '260px';
        toast.innerHTML = `<div class="d-flex"><div class="toast-body"><i class="bi bi-info-circle me-2" style="color:#4b0082"></i>Section coming soon!</div><button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2500);
      });
    });

    // Health pill
    (async function() {
      const pill = document.getElementById('status');
      try {
        const res = await fetch('/health', { cache: 'no-store' });
        const data = await res.json();
        if (data && data.status) {
          pill.innerHTML = `<span class="me-2" style="display:inline-block;width:8px;height:8px;border-radius:999px;background:#22c55e"></span>${data.status}`;
        } else {
          pill.innerHTML = `<span class="me-2" style="display:inline-block;width:8px;height:8px;border-radius:999px;background:#f59e0b"></span>Unknown`;
        }
      } catch(e) {
        pill.innerHTML = `<span class="me-2" style="display:inline-block;width:8px;height:8px;border-radius:999px;background:#ef4444"></span>Offline`;
      }
    })();

    // Authentication state
    let isLoggedIn = false;
    let currentUser = null;

    // UI Elements
    const authButtons = document.getElementById('authButtons');
    const profileSection = document.getElementById('profileSection');
    const profileName = document.getElementById('profileName');
    const heroCTA = document.getElementById('heroCTA');
    const welcomeMessage = document.getElementById('welcomeMessage');
    const welcomeName = document.getElementById('welcomeName');

    // Enhanced API helper function with proper JSON handling
    async function apiCall(url, method = 'GET', data = null) {
      const options = {
        method,
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        credentials: 'include' // Include cookies for session management
      };

      if (data) {
        options.body = JSON.stringify(data);
      }

      try {
        console.log(`Making ${method} request to ${url}`, data); // Debug logging

        const response = await fetch(url, options);
        console.log(`Response status: ${response.status}, Content-Type: ${response.headers.get('content-type')}`);

        // Check if response is actually JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const textResponse = await response.text();
          console.error('Non-JSON response received:', textResponse);
          return {
            success: false,
            message: 'Server returned non-JSON response. Please check server configuration.'
          };
        }

        // Parse JSON response
        const result = await response.json();
        console.log('API response:', result); // Debug logging

        // Return the result regardless of HTTP status
        // The success field in the JSON will indicate if the operation was successful
        return result;

      } catch (error) {
        console.error('API call failed:', error);

        // Handle specific error types
        if (error.name === 'SyntaxError' && error.message.includes('JSON')) {
          return {
            success: false,
            message: 'Server returned invalid JSON. Please check server configuration.'
          };
        }

        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          return {
            success: false,
            message: 'Network connection failed. Please check if the server is running.'
          };
        }

        return {
          success: false,
          message: `Network error: ${error.message}`
        };
      }
    }

    // Show/Hide UI based on login status
    function updateUI() {
      console.log('Updating UI - isLoggedIn:', isLoggedIn, 'currentUser:', currentUser);

      if (isLoggedIn && currentUser) {
        console.log('User is logged in - hiding auth buttons, showing profile');

        // HIDE login/register buttons completely
        if (authButtons) {
          authButtons.style.display = 'none';
          authButtons.style.visibility = 'hidden';
          console.log('Hidden navbar auth buttons');
        }
        if (heroCTA) {
          heroCTA.style.display = 'none';
          heroCTA.style.visibility = 'hidden';
          console.log('Hidden hero auth buttons');
        }

        // SHOW profile section
        if (profileSection) {
          profileSection.style.display = 'flex';
          profileSection.style.visibility = 'visible';
          console.log('Shown profile section');
        }

        // Show welcome message if exists
        if (welcomeMessage) {
          welcomeMessage.style.display = 'block';
          if (welcomeName) {
            welcomeName.textContent = currentUser;
          }
          console.log('Shown welcome message');
        }

        // Update user name in profile
        if (profileName) {
          profileName.textContent = currentUser;
          console.log('Updated profile name to:', currentUser);
        }

        console.log('✅ UI Updated: User logged in as', currentUser);
      } else {
        console.log('User is not logged in - showing auth buttons, hiding profile');

        // SHOW login/register buttons
        if (authButtons) {
          authButtons.style.display = 'flex';
          authButtons.style.visibility = 'visible';
          console.log('Shown navbar auth buttons');
        }
        if (heroCTA) {
          heroCTA.style.display = 'block';
          heroCTA.style.visibility = 'visible';
          console.log('Shown hero auth buttons');
        }

        // HIDE profile section
        if (profileSection) {
          profileSection.style.display = 'none';
          profileSection.style.visibility = 'hidden';
          console.log('Hidden profile section');
        }

        // Hide welcome message if exists
        if (welcomeMessage) {
          welcomeMessage.style.display = 'none';
          console.log('Hidden welcome message');
        }

        console.log('✅ UI Updated: User logged out');
      }
    }

    // Enhanced Register modal action
    document.getElementById('createAccountBtn').addEventListener('click', async () => {
      const btn = document.getElementById('createAccountBtn');

      try {
        // Get form data
        const name = document.getElementById('registerName').value.trim();
        const year = document.getElementById('registerYear').value;
        const branch = document.getElementById('registerBranch').value;
        const password = document.getElementById('registerPassword').value;

        console.log('Registration form data:', { name, year, branch, password: '***' });

        // Client-side validation
        if (!name || name.length < 2) {
          alert('Please enter a valid name (at least 2 characters).');
          return;
        }

        if (!year) {
          alert('Please select your year.');
          return;
        }

        if (!branch) {
          alert('Please select your branch.');
          return;
        }

        if (!password || password.length < 4) {
          alert('Please enter a password (at least 4 characters).');
          return;
        }

        // Disable button to prevent double submission
        btn.disabled = true;
        btn.textContent = 'Creating Account...';

        // Call registration API
        const result = await apiCall('/api/auth/register', 'POST', {
          name: name,
          year: year,
          branch: branch,
          password: password
        });

        // Re-enable button
        btn.disabled = false;
        btn.textContent = 'Create Account';

        // Handle response
        if (result && result.success) {
          // Set user as logged in
          currentUser = result.user.name;
          isLoggedIn = true;

          console.log('Registration successful - updating UI');

          // Update UI immediately and force hide auth buttons
          updateUI();

          // Double-check: Force hide auth buttons
          setTimeout(() => {
            if (authButtons) authButtons.style.display = 'none';
            if (heroCTA) heroCTA.style.display = 'none';
            if (profileSection) profileSection.style.display = 'flex';
          }, 100);

          // Show success message
          alert(`Account created successfully! Welcome, ${result.user.name}!`);

          // Clear form and close modal
          document.getElementById('registerForm').reset();
          const modal = bootstrap.Modal.getInstance(document.getElementById('registerModal'));
          modal && modal.hide();
        } else {
          // Show error message from server or generic message
          const errorMessage = result && result.message ? result.message : 'Registration failed. Please try again.';
          alert(errorMessage);
          console.error('Registration failed:', result);
        }

      } catch (error) {
        console.error('Registration error:', error);
        alert('An unexpected error occurred during registration. Please try again.');

        // Re-enable button
        btn.disabled = false;
        btn.textContent = 'Create Account';
      }
    });

    // Enhanced Login modal action
    document.getElementById('loginBtn').addEventListener('click', async () => {
      const btn = document.getElementById('loginBtn');

      try {
        // Get form data
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value;

        console.log('Login form data:', { username, password: '***' });

        // Client-side validation
        if (!username || username.length < 2) {
          alert('Please enter a valid username.');
          return;
        }

        if (!password) {
          alert('Please enter your password.');
          return;
        }

        // Disable button to prevent double submission
        btn.disabled = true;
        btn.textContent = 'Logging in...';

        // Call login API
        const result = await apiCall('/api/auth/login', 'POST', {
          username: username,
          password: password
        });

        // Re-enable button
        btn.disabled = false;
        btn.textContent = 'Login';

        // Handle response
        if (result && result.success) {
          // Set user as logged in
          currentUser = result.user.name;
          isLoggedIn = true;

          console.log('Login successful - updating UI');

          // Update UI immediately and force hide auth buttons
          updateUI();

          // Double-check: Force hide auth buttons
          setTimeout(() => {
            if (authButtons) authButtons.style.display = 'none';
            if (heroCTA) heroCTA.style.display = 'none';
            if (profileSection) profileSection.style.display = 'flex';
          }, 100);

          // Show success message
          alert(`Welcome back, ${result.user.name}!`);

          // Clear form and close modal
          document.getElementById('loginForm').reset();
          const modal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
          modal && modal.hide();
        } else {
          // Show error message from server or generic message
          const errorMessage = result && result.message ? result.message : 'Login failed. Please check your credentials.';
          alert(errorMessage);
          console.error('Login failed:', result);
        }

      } catch (error) {
        console.error('Login error:', error);
        alert('An unexpected error occurred during login. Please try again.');

        // Re-enable button
        btn.disabled = false;
        btn.textContent = 'Login';
      }
    });

    // Logout function
    async function logout() {
      try {
        console.log('Logging out user...');

        // Call logout API
        const result = await apiCall('/api/auth/logout', 'POST');

        // Clear authentication state regardless of API response
        isLoggedIn = false;
        currentUser = null;

        // Update UI immediately
        updateUI();

        if (result.success) {
          alert('Logged out successfully!');
        } else {
          alert('Logged out (session cleared)');
        }
      } catch (error) {
        console.error('Logout error:', error);
        // Still clear local state even if API fails
        isLoggedIn = false;
        currentUser = null;
        updateUI();
        alert('Logged out (session cleared)');
      }
    }

    // Check authentication status on page load
    async function checkAuthStatus() {
      try {
        console.log('Checking authentication status...');
        const result = await apiCall('/api/auth/status');

        console.log('Auth status result:', result);

        if (result.authenticated && result.user) {
          isLoggedIn = true;
          currentUser = result.user.name;
          console.log('User is authenticated:', result.user.name);
        } else {
          isLoggedIn = false;
          currentUser = null;
          console.log('User is not authenticated');
        }

        // Update UI based on authentication state
        updateUI();
      } catch (error) {
        console.error('Auth status check error:', error);
        // Default to not authenticated on error
        isLoggedIn = false;
        currentUser = null;
        updateUI();
      }
    }

    // Protected routes (prototype)
    function protectNavigation(e){
      if(!isLoggedIn){
        e.preventDefault();
        const regModal = new bootstrap.Modal(document.getElementById('registerModal'));
        regModal.show();
      }
    }
    document.querySelectorAll('.requires-auth').forEach(el=>{
      el.addEventListener('click', protectNavigation);
    });

    // Initialize authentication status on page load
    checkAuthStatus();

    // AI Service Integration
    class AIService {
        constructor(baseUrl = 'http://127.0.0.1:8000') {
            this.baseUrl = baseUrl;
        }

        async predict(text, options = {}) {
            const requestData = {
                text: text,
                ...options
            };

            try {
                console.log('Sending AI request:', requestData);

                const response = await fetch(`${this.baseUrl}/predict`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('AI response:', data);
                return data;

            } catch (error) {
                console.error('AI Service Error:', error);
                throw new Error(`AI prediction failed: ${error.message}`);
            }
        }

        async analyzeText(text) {
            return this.predict(text, { task: 'analysis' });
        }

        async generateResponse(text) {
            return this.predict(text, { task: 'generation' });
        }
    }

    // Initialize AI service
    const aiService = new AIService();

    // AI UI Functions
    function showLoadingState() {
        const loadingEl = document.getElementById('aiLoading');
        if (loadingEl) {
            loadingEl.style.display = 'block';
        }
    }

    function hideLoadingState() {
        const loadingEl = document.getElementById('aiLoading');
        if (loadingEl) {
            loadingEl.style.display = 'none';
        }
    }

    function displayAIResponse(data) {
        const responseEl = document.getElementById('aiResponse');
        if (responseEl) {
            responseEl.innerHTML = `
                <div class="alert alert-success">
                    <h5><i class="bi bi-robot"></i> AI Response:</h5>
                    <p>${data.response || data.prediction || JSON.stringify(data, null, 2)}</p>
                    <small class="text-muted">Response time: ${new Date().toLocaleTimeString()}</small>
                </div>
            `;
        }
    }

    function showErrorMessage(message) {
        const errorEl = document.getElementById('aiError');
        if (errorEl) {
            errorEl.innerHTML = `
                <div class="alert alert-danger">
                    <strong><i class="bi bi-exclamation-triangle"></i> Error:</strong> ${message}
                </div>
            `;
        }
    }

    function clearAIChat() {
        document.getElementById('aiInput').value = '';
        document.getElementById('aiResponse').innerHTML = '';
        document.getElementById('aiError').innerHTML = '';
    }

    // AI Request Handler
    async function handleAIRequest() {
        const inputEl = document.getElementById('aiInput');
        const inputText = inputEl.value.trim();

        if (!inputText) {
            showErrorMessage('Please enter a message to send to the AI.');
            return;
        }

        // Clear previous responses
        document.getElementById('aiError').innerHTML = '';

        showLoadingState();

        try {
            const result = await aiService.predict(inputText);
            displayAIResponse(result);
        } catch (error) {
            showErrorMessage(error.message);
        } finally {
            hideLoadingState();
        }
    }

    // Event Listeners for AI Section
    document.addEventListener('DOMContentLoaded', function() {
        const sendBtn = document.getElementById('sendAIRequest');
        const clearBtn = document.getElementById('clearAIChat');
        const inputEl = document.getElementById('aiInput');

        if (sendBtn) {
            sendBtn.addEventListener('click', handleAIRequest);
        }

        if (clearBtn) {
            clearBtn.addEventListener('click', clearAIChat);
        }

        if (inputEl) {
            inputEl.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && e.ctrlKey) {
                    handleAIRequest();
                }
            });
        }
    });
  </script>
</body>
</html>

