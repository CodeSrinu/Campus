
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Campus App</title>
  <!-- Bootstrap CSS & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- App Styles -->
  <link href="/static/style.css" rel="stylesheet" />

</head>
<body class="bg-body">
  <!-- Fixed Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top border-bottom app-navbar" id="top">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center gap-2" href="#">
        <i class="bi bi-mortarboard-fill icon-primary"></i>
        <span class="fw-semibold">Smart Campus App</span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="mainNav">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link requires-auth" href="/map"><i class="bi bi-geo-alt me-1"></i>Navigation</a></li>
          <li class="nav-item"><a class="nav-link" href="/events"><i class="bi bi-calendar-event me-1"></i>Events</a></li>
          <li class="nav-item"><a class="nav-link" href="/lost-found"><i class="bi bi-search me-1"></i>Lost &amp; Found</a></li>
          <li class="nav-item"><a class="nav-link" href="/cafeteria"><i class="bi bi-cup-hot me-1"></i>Cafeteria</a></li>
        </ul>
        <div class="d-flex gap-2" id="authSection">
          <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#loginModal">
            <i class="bi bi-box-arrow-in-right me-1"></i>Login
          </button>
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registerModal">
            <i class="bi bi-person-plus-fill me-1"></i>Register
          </button>
        </div>
      </div>
    </div>
  </nav>

  <main class="mt-5 pt-4">
    <!-- Hero -->
    <section class="py-5">

      <div class="container">
        <div class="row align-items-center g-4">
          <div class="col-12 col-lg-7">
            <h1 class="display-5 fw-bold mb-3 hero-title" id="heroTitle">Your Campus, Simplified.</h1>
            <p class="lead mb-4 hero-sub" id="heroSubtitle">
              The one-stop app for all your campus needs. From finding events to tracking your grievances, connect to your campus like never before.
            </p>

          </div>

                <!-- Centered vertical CTAs below title and content -->
              

                <!-- Inline script to hide hero CTA immediately if user is logged in -->
                <script>
                  (function() {
                    const sessionId = localStorage.getItem('session_id');
                    const userInfo = localStorage.getItem('user_info');
                    if (sessionId && userInfo) {
                      const heroCTA = document.getElementById('heroCTA');
                      if (heroCTA) {
                        heroCTA.style.display = 'none';
                      }
                    }
                  })();
                </script>


        </div>
      </div>
    </section>


    <!-- Feature Highlights (attractive card view) -->
    <section class="section-features pb-5">
      <div class="container">

        <div class="glass-card p-3 p-md-4 rounded-4 shadow-soft">
        

            </div>
            <div class="mb-3">
              <label class="form-label">Password</label>
              <input type="password" class="form-control" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="createAccountBtn">Create Account</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Status pill (health) -->
  <div id="status" class="position-fixed bottom-0 end-0 m-3 px-3 py-2 rounded-pill border bg-white small shadow-sm">
    Checking backend…
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script>
    // Palette to Bootstrap variables
    document.documentElement.style.setProperty('--bs-primary', '#0f1e4b');
    document.documentElement.style.setProperty('--bs-body-bg', '#f7f9fc');
    document.documentElement.style.setProperty('--bs-body-color', '#0f172a');

    // Coming soon links - removed to allow navigation to all sections

    // Health pill
    (async function() {
      const pill = document.getElementById('status');
      try {
        const res = await fetch('/health', { cache: 'no-store' });
        const data = await res.json();
        if (data && data.status) {
          pill.innerHTML = `<span class="me-2" style="display:inline-block;width:8px;height:8px;border-radius:999px;background:#22c55e"></span>${data.status}`;
        } else {
          pill.innerHTML = `<span class="me-2" style="display:inline-block;width:8px;height:8px;border-radius:999px;background:#f59e0b"></span>Unknown`;
        }
      } catch(e) {
        pill.innerHTML = `<span class="me-2" style="display:inline-block;width:8px;height:8px;border-radius:999px;background:#ef4444"></span>Offline`;
      }
    })();

    // Register modal action
    document.getElementById('createAccountBtn').addEventListener('click', async () => {
      const form = document.getElementById('registerForm');
      const submitBtn = document.getElementById('createAccountBtn');
      const originalText = submitBtn.innerHTML;

      // Show loading state
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Creating Account...';

      const registerData = {
        register_number: form.querySelector('input[type="text"]').value,
        password: form.querySelector('input[type="password"]').value,
        year: form.querySelector('select').value,
        branch: form.querySelectorAll('select')[1].value
      };

      try {
        const response = await fetch('/api/auth/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(registerData)
        });

        const result = await response.json();

        if (result.success) {
          // Show success toast instead of alert
          showToast('success', result.message);
          const modal = bootstrap.Modal.getInstance(document.getElementById('registerModal'));
          modal && modal.hide();
          form.reset();

          // Auto-login after successful registration
          const loginData = {
            register_number: registerData.register_number,
            password: registerData.password
          };

          // Perform auto-login
          setTimeout(async () => {
            try {
              const loginResponse = await fetch('/api/auth/login', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify(loginData)
              });

              const loginResult = await loginResponse.json();

              if (loginResult.success) {
                localStorage.setItem('session_id', loginResult.session_id);
                localStorage.setItem('user_info', JSON.stringify(loginResult.user));
                isLoggedIn = true;
                updateUIForLoggedInUser(loginResult.user);
              }
            } catch (error) {
              console.error('Auto-login failed:', error);
            }
          }, 1000);
        } else {
          showToast('error', 'Registration failed: ' + result.message);
        }
      } catch (error) {
        showToast('error', 'Registration failed: ' + error.message);
      } finally {
        // Reset button state
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    });

    // Login modal action
    document.getElementById('loginBtn').addEventListener('click', async () => {
      const form = document.getElementById('loginForm');
      const submitBtn = document.getElementById('loginBtn');
      const originalText = submitBtn.innerHTML;

      // Show loading state
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Signing In...';

      const loginData = {
        register_number: form.querySelector('input[type="text"]').value,
        password: form.querySelector('input[type="password"]').value
      };

      try {
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(loginData)
        });

        const result = await response.json();

        if (result.success) {
          showToast('success', result.message);
          // Store session info
          localStorage.setItem('session_id', result.session_id);
          localStorage.setItem('user_info', JSON.stringify(result.user));
          isLoggedIn = true;

          const modal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
          modal && modal.hide();
          form.reset();

          // Update UI to show logged in state
          updateUIForLoggedInUser(result.user);
        } else {
          showToast('error', 'Login failed: ' + result.message);
        }
      } catch (error) {
        showToast('error', 'Login failed: ' + error.message);
      } finally {
        // Reset button state
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    });

    // Protected routes (prototype)
    let isLoggedIn = false;
    function protectNavigation(e){
      if(!isLoggedIn){
        e.preventDefault();
        const regModal = new bootstrap.Modal(document.getElementById('registerModal'));
        regModal.show();
      }
    }
    document.querySelectorAll('.requires-auth').forEach(el=>{
      el.addEventListener('click', protectNavigation);
    });

    // Function to update UI for logged in user
    function updateUIForLoggedInUser(user) {
      const authSection = document.getElementById('authSection');
      const heroCTA = document.getElementById('heroCTA');
      const heroTitle = document.getElementById('heroTitle');
      const heroSubtitle = document.getElementById('heroSubtitle');

      // Add logged-in class to body for CSS targeting
      document.body.classList.add('user-logged-in');

      // Hide hero CTA buttons (multiple approaches for reliability)
      if (heroCTA) {
        heroCTA.style.display = 'none';
        heroCTA.classList.add('d-none');
        heroCTA.style.visibility = 'hidden';
      }

      // Update hero text for logged-in user
      if (heroTitle && heroSubtitle) {
        heroTitle.innerHTML = `Welcome back, ${user.register_number}!`;
        heroSubtitle.innerHTML = `Ready to explore your campus? Access all your favorite features and stay connected with campus life.`;
      }

      console.log('UI updated for logged in user:', user.register_number);

      // Create modern user profile dropdown
      authSection.innerHTML = `
        <div class="dropdown">
          <button class="btn btn-outline-primary dropdown-toggle user-profile-btn d-flex align-items-center gap-2" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            <div class="user-avatar">
              <i class="bi bi-person-circle"></i>
            </div>
            <div class="user-info d-none d-md-block">
              <div class="user-name">${user.register_number}</div>
              <div class="user-details">${user.year}${getOrdinalSuffix(user.year)} Year • ${user.branch}</div>
            </div>
          </button>
          <ul class="dropdown-menu dropdown-menu-end user-dropdown-menu">
            <li class="dropdown-header">
              <div class="d-flex align-items-center gap-3">
                <div class="user-avatar-large">
                  <i class="bi bi-person-circle"></i>
                </div>
                <div>
                  <div class="fw-semibold">${user.register_number}</div>
                  <div class="text-muted small">${user.year}${getOrdinalSuffix(user.year)} Year • ${user.branch}</div>
                </div>
              </div>
            </li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i>Profile</a></li>
            <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>Settings</a></li>
            <li><a class="dropdown-item" href="#"><i class="bi bi-bell me-2"></i>Notifications</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
          </ul>
        </div>
      `;
    }

    // Helper function to get ordinal suffix
    function getOrdinalSuffix(num) {
      const j = num % 10;
      const k = num % 100;
      if (j == 1 && k != 11) return "st";
      if (j == 2 && k != 12) return "nd";
      if (j == 3 && k != 13) return "rd";
      return "th";
    }

    // Logout function
    function logout() {
      localStorage.removeItem('session_id');
      localStorage.removeItem('user_info');
      isLoggedIn = false;
      document.body.classList.remove('user-logged-in');
      showToast('info', 'Logged out successfully');
      setTimeout(() => {
        location.reload(); // Refresh page to reset UI
      }, 1000);
    }

    // Toast notification function
    function showToast(type, message) {
      const toastContainer = document.getElementById('toastContainer') || createToastContainer();
      const toastId = 'toast-' + Date.now();

      const iconMap = {
        success: 'bi-check-circle-fill',
        error: 'bi-exclamation-triangle-fill',
        info: 'bi-info-circle-fill',
        warning: 'bi-exclamation-circle-fill'
      };

      const colorMap = {
        success: 'text-bg-success',
        error: 'text-bg-danger',
        info: 'text-bg-info',
        warning: 'text-bg-warning'
      };

      const toast = document.createElement('div');
      toast.id = toastId;
      toast.className = `toast align-items-center ${colorMap[type]} border-0`;
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');

      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body d-flex align-items-center gap-2">
            <i class="bi ${iconMap[type]}"></i>
            ${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      `;

      toastContainer.appendChild(toast);

      const bsToast = new bootstrap.Toast(toast, {
        autohide: true,
        delay: 4000
      });

      bsToast.show();

      // Remove toast element after it's hidden
      toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
      });
    }

    // Create toast container if it doesn't exist
    function createToastContainer() {
      const container = document.createElement('div');
      container.id = 'toastContainer';
      container.className = 'toast-container position-fixed top-0 end-0 p-3';
      container.style.zIndex = '9999';
      document.body.appendChild(container);
      return container;
    }

    // Check if user is already logged in on page load
    window.addEventListener('load', () => {
      const sessionId = localStorage.getItem('session_id');
      const userInfo = localStorage.getItem('user_info');

      console.log('Page loaded. Session ID:', sessionId, 'User Info:', userInfo);

      if (sessionId && userInfo) {
        isLoggedIn = true;
        updateUIForLoggedInUser(JSON.parse(userInfo));
      }
    });

    // Also check on DOMContentLoaded in case load event has timing issues
    document.addEventListener('DOMContentLoaded', () => {
      const sessionId = localStorage.getItem('session_id');
      const userInfo = localStorage.getItem('user_info');

      if (sessionId && userInfo) {
        isLoggedIn = true;
        updateUIForLoggedInUser(JSON.parse(userInfo));
      }
    });

    // Immediate check (runs as soon as script loads)
    (function() {
      const sessionId = localStorage.getItem('session_id');
      const userInfo = localStorage.getItem('user_info');

      if (sessionId && userInfo) {
        isLoggedIn = true;
        // Set a timeout to ensure DOM is ready
        setTimeout(() => {
          updateUIForLoggedInUser(JSON.parse(userInfo));
        }, 100);
      }
    })();
  </script>
</body>
</html>